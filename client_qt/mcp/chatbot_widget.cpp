#include "chatbot_widget.h"
#include "../ai_command.h"
#include "MCPAgentClient.h"

#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QLabel>
#include <QPushButton>
#include <QScrollArea>
#include <QLineEdit>
#include <QTextEdit>
#include <QTextDocument>
#include <QRegularExpression>
#include <QDateTime>
#include <QDebug>
#include <QMouseEvent>
#include <QApplication>
#include <QTimer>
#include <QScrollBar>
#include <QtMqtt/QMqttClient>
#include <QtMqtt/QMqttTopicName>

ChatBotWidget::ChatBotWidget(QWidget *parent)
    : QWidget(parent), waitingForResponse(false)
{
    setFixedSize(504, 760);
    setWindowFlags(Qt::FramelessWindowHint | Qt::Tool);
    setAttribute(Qt::WA_TranslucentBackground);

    QFrame *outerFrame = new QFrame(this);
    outerFrame->setObjectName("outerFrame");
    outerFrame->setStyleSheet("QFrame#outerFrame { background-color: #f97316; border-radius: 16px; }");
    outerFrame->setFixedSize(504, 760);

    QFrame *innerFrame = new QFrame(outerFrame);
    innerFrame->setObjectName("innerFrame");
    innerFrame->setStyleSheet("QFrame#innerFrame { background-color: white; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }");
    innerFrame->setMinimumSize(504, 685);

    QWidget *header = new QWidget(outerFrame);
    header->setMinimumHeight(75);
    header->setMaximumHeight(75);
    header->setCursor(Qt::SizeAllCursor);
    m_headerWidget = header;
    QHBoxLayout *headerLayout = new QHBoxLayout(header);
    headerLayout->setContentsMargins(14, 12, 14, 12);

    QVBoxLayout *outerLayout = new QVBoxLayout(outerFrame);
    outerLayout->setContentsMargins(0, 0, 0, 0);
    outerLayout->setSpacing(0);
    outerLayout->addWidget(header);
    outerLayout->addWidget(innerFrame);

    QLabel *title = new QLabel("<b>ü§ñ VisionCraft AI</b>");
    title->setStyleSheet("color: white; font-size: 17px; padding: 3px 0px; line-height: 1.2;");
    title->setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Preferred);
    title->setWordWrap(false);
    title->setTextInteractionFlags(Qt::NoTextInteraction);
    title->setMinimumHeight(24);

    QLabel *subtitle = new QLabel("Ïä§ÎßàÌä∏ Ìå©ÌÜ†Î¶¨ CCTV AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏");
    subtitle->setStyleSheet("color: white; font-size: 12px; padding: 4px 0px; line-height: 1.2;");
    subtitle->setMinimumHeight(20);

    QVBoxLayout *titleBox = new QVBoxLayout;
    titleBox->addWidget(title);
    titleBox->addWidget(subtitle);
    titleBox->setSpacing(2);
    titleBox->setContentsMargins(0, 2, 0, 2);

    closeButton = new QPushButton("\u2715");
    closeButton->setStyleSheet("background: transparent; color: white; border: none; font-size: 16px;");
    closeButton->setFixedSize(28, 28);
    connect(closeButton, &QPushButton::clicked, this, &ChatBotWidget::hide);

    headerLayout->addLayout(titleBox);
    headerLayout->addStretch();
    headerLayout->addWidget(closeButton);

    QVBoxLayout *mainLayout = new QVBoxLayout(innerFrame);
    mainLayout->setContentsMargins(14, 14, 14, 22);
    mainLayout->setSpacing(15);

    scrollArea = new QScrollArea(innerFrame);
    scrollArea->setWidgetResizable(true);
    scrollArea->setStyleSheet("QScrollArea { border: none; background-color: transparent; }");

    messageContainer = new QWidget;
    messageContainer->setStyleSheet("background-color: white;");
    messageLayout = new QVBoxLayout(messageContainer);
    messageLayout->setAlignment(Qt::AlignTop);

    scrollArea->setWidget(messageContainer);
    mainLayout->addWidget(scrollArea, 1);

    // Îπ†Î•∏ ÏùëÎãµ Î≤ÑÌäº
    QHBoxLayout *quickLayout = new QHBoxLayout;
    QStringList quickTexts = {
        "Í∏∞Îä• ÏÜåÍ∞ú",
        "Ïª®Î≤†Ïù¥Ïñ¥ Ï†ïÎ≥¥",
        "Î∂àÎüâÎ•† ÌÜµÍ≥Ñ",
        "ÌîºÎçî ÏºúÏ§ò"};

    for (const QString &text : quickTexts)
    {
        QPushButton *quick = new QPushButton(text);
        quick->setStyleSheet("font-size: 13px; padding: 7px; background-color: #f3f4f6; border-radius: 7px;");
        connect(quick, &QPushButton::clicked, this, [=]()
                {
            QString command = text;
            if (text == "Í∏∞Îä• ÏÜåÍ∞ú") {
                command = "Ïñ¥Îñ§ Í∏∞Îä•Ïù¥ ÏûàÏñ¥?";
            } else if (text == "Ïª®Î≤†Ïù¥Ïñ¥ Ï†ïÎ≥¥") {
                command = "Ïª®Î≤†Ïù¥Ïñ¥1 Ïò§Îäò Ï†ïÎ≥¥ Î≥¥Ïó¨Ï§ò";
            } else if (text == "Î∂àÎüâÎ•† ÌÜµÍ≥Ñ") {
                command = "Ïª®Î≤†Ïù¥Ïñ¥1 Î∂àÎüâÎ•† ÏïåÎ†§Ï§ò";
            } else if (text == "ÌîºÎçî ÏºúÏ§ò") {
                command = "ÌîºÎçî2 Í∏∞Í∏∞Î•º ÏºúÏ§ò";
            }
            input->setText(command);
            handleSend(); });
        quickLayout->addWidget(quick);
    }

    mainLayout->addLayout(quickLayout);

    // ÏûÖÎ†•Ï∞Ω + Ï†ÑÏÜ°
    QHBoxLayout *inputLayout = new QHBoxLayout;
    input = new QLineEdit(this);
    input->setPlaceholderText("AIÏóêÍ≤å ÏßàÎ¨∏Ìï¥Î≥¥ÏÑ∏Ïöî...");
    input->setStyleSheet("background-color: #f3f4f6; border: none; border-radius: 12px; padding: 15px; font-size: 14px; min-height: 22px;");
    sendButton = new QPushButton("Ï†ÑÏÜ°");
    sendButton->setFixedSize(55, 52);
    sendButton->setStyleSheet("background-color: #fb923c; color: white; border: none; border-radius: 12px; font-size: 14px;");
    connect(sendButton, &QPushButton::clicked, this, &ChatBotWidget::handleSend);
    connect(input, &QLineEdit::returnPressed, this, &ChatBotWidget::handleSend);
    inputLayout->addWidget(input);
    inputLayout->addWidget(sendButton);
    mainLayout->addLayout(inputLayout);

    ChatMessage welcome = {"bot", "ÏïàÎÖïÌïòÏÑ∏Ïöî.\nÏä§ÎßàÌä∏Ìå©ÌÜ†Î¶¨ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.\n\nÏû•ÎπÑ Ï†úÏñ¥, Î°úÍ∑∏ Ï°∞Ìöå, ÌÜµÍ≥Ñ Î∂ÑÏÑù Îì±ÏùÑ ÎèÑÏôÄÎìúÎ¶ΩÎãàÎã§.\nÏñ¥Îñ§ ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÏã†Í∞ÄÏöî?", getCurrentTime()};
    addMessage(welcome);

    initializeMqttClient();
    m_deviceStates["feeder_02"] = "off";
    m_deviceStates["conveyor_03"] = "off";
}

void ChatBotWidget::setMcpServerUrl(const QString &url)
{

    mcpServerUrl = url;
}

void ChatBotWidget::setGemini(GeminiRequester *requester)
{
    this->gemini = requester;

    // MCP ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
    if (gemini && !gemini->getApiKey().isEmpty())
    {
        mcpClient = std::make_unique<MCPAgentClient>(
            mcpServerUrl,
            gemini->getApiKey(),
            this);

        // MQTT ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï†ÑÎã¨
        mcpClient->setMqttClient(m_mqttClient);

        // ÌÜµÌï© ÌååÏù¥ÌîÑÎùºÏù∏ ÏãúÍ∑∏ÎÑê Ïó∞Í≤∞
        connect(mcpClient.get(), &MCPAgentClient::pipelineCompleted,
                this, [this](const QString &result)
                {
            ChatMessage botMsg = {"bot", result, getCurrentTime()};
            addMessage(botMsg);
            waitingForResponse = false;
            sendButton->setEnabled(true); });

        connect(mcpClient.get(), &MCPAgentClient::pipelineStateChanged,
                this, [this](PipelineState state)
                {
                    // ÏÉÅÌÉúÎ≥Ñ UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏòµÏÖò)
                    QString stateMsg;
                    switch (state)
                    {
                    case PipelineState::DISCOVERING_TOOL:
                        stateMsg = "üîç ÏöîÏ≤≠ Î∂ÑÏÑù Ï§ë...";
                        break;
                    case PipelineState::EXECUTING_TOOL:
                        stateMsg = "‚ö° ÎèÑÍµ¨ Ïã§Ìñâ Ï§ë...";
                        break;
                    case PipelineState::FORMATTING_RESULT:
                        stateMsg = "üìã Í≤∞Í≥º Ï†ïÎ¶¨ Ï§ë...";
                        break;
                    default:
                        return;
                    }
                    // ÏûÑÏãú Î©îÏãúÏßÄ ÌëúÏãú (ÏòµÏÖò)
                });

        connect(mcpClient.get(), &MCPAgentClient::errorOccurred,
                this, [this](const QString &error)
                {
            ChatMessage errorMsg = {
                "bot",
                QString("‚ö†Ô∏è Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: %1").arg(error),
                getCurrentTime()
            };
            addMessage(errorMsg);
            waitingForResponse = false;
            sendButton->setEnabled(true); });

        // ÎèÑÍµ¨ Î™©Î°ù ÎØ∏Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞
        mcpClient->fetchTools(true);
    }
}

void ChatBotWidget::onMcpError(const QString &error)
{
    ChatMessage errorMsg = {
        "bot",
        QString("‚ö†Ô∏è Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: %1").arg(error),
        getCurrentTime()};
    addMessage(errorMsg);

    waitingForResponse = false;
    sendButton->setEnabled(true);
}

void ChatBotWidget::addMessage(const ChatMessage &msg)
{
    // 1. Î©îÏãúÏßÄ ÎùºÎ≤®(ÎßêÌíçÏÑ† ÎÇ¥Ïö©) ÏÉùÏÑ±
    QLabel *msgLabel = new QLabel();
    msgLabel->setWordWrap(true); // ÏûêÎèô Ï§ÑÎ∞îÍøà ÌôúÏÑ±Ìôî (ÌïµÏã¨!)
    msgLabel->setTextInteractionFlags(Qt::TextSelectableByMouse);

    // Ï±óÎ¥á ÏúÑÏ†ØÏùò Ï†ÑÏ≤¥ ÎÑàÎπÑ(504px)ÏóêÏÑú Ïó¨Î∞± Îì±ÏùÑ Î∫Ä Í∞íÏúºÎ°ú ÏµúÎåÄ ÎÑàÎπÑÎ•º Í≥†Ï†ï
    int maxBubbleWidth = this->width() * 0.75; // ÏïΩ 75% Ï†ïÎèÑÎ°ú ÏÑ§Ï†ï
    msgLabel->setMaximumWidth(maxBubbleWidth);

    // HTML ÏÑúÏãù Ï†ÅÏö©
    QString formattedContent = msg.content;
    formattedContent.replace("\n", "<br>");
    formattedContent.replace(QRegularExpression(R"(###\s*(.*?)<br>)"), "<b>\\1</b><br>");
    formattedContent.replace(QRegularExpression(R"(\*\s+(.*?)<br>)"), "\\1<br>");
    formattedContent.replace(QRegularExpression(R"(\*\*(.*?)\*\*)"), "<b>\\1</b>");
    formattedContent.replace(QRegularExpression(R"(```(.*?)```)"), "<pre style='background-color: #f0f0f0; padding: 5px;'>\\1</pre>");
    msgLabel->setText(formattedContent);

    // 2. Î∞úÏã†ÏûêÏóê Îî∞Îùº Ïä§ÌÉÄÏùºÏãúÌä∏ Ï†ÅÏö©
    if (msg.sender == "bot")
    {
        msgLabel->setStyleSheet("background-color: #f3f4f6; color: black; padding: 14px; border-radius: 14px; font-family: 'Hanwha Gothic', 'Malgun Gothic', sans-serif; font-size: 14px;");
    }
    else
    {
        msgLabel->setStyleSheet("background-color: #fb923c; color: white; padding: 14px; border-radius: 14px; font-family: 'Hanwha Gothic', 'Malgun Gothic', sans-serif; font-size: 14px;");
    }

    // 3. ÏãúÍ∞Ñ ÎùºÎ≤® ÏÉùÏÑ±
    QLabel *timeLabel = new QLabel(msg.time);
    timeLabel->setStyleSheet("font-size: 12px; color: gray;");

    // 4. Î©îÏãúÏßÄÏôÄ ÏãúÍ∞ÑÏùÑ Î¨∂Îäî ÏàòÏßÅ Î†àÏù¥ÏïÑÏõÉ (Ïã§Ï†ú ÎßêÌíçÏÑ†)
    QVBoxLayout *bubbleContentLayout = new QVBoxLayout();
    bubbleContentLayout->setSpacing(4);
    bubbleContentLayout->addWidget(msgLabel);
    bubbleContentLayout->addWidget(timeLabel);

    QWidget *bubbleWidget = new QWidget();
    bubbleWidget->setLayout(bubbleContentLayout);

    // 5. [ÌïµÏã¨ Î≥ÄÍ≤Ω] SpacerÎ•º Ïù¥Ïö©Ìïú Ï¢å/Ïö∞ Ï†ïÎ†¨
    QHBoxLayout *wrapperLayout = new QHBoxLayout();
    wrapperLayout->setContentsMargins(0, 0, 0, 0);

    if (msg.sender == "bot")
    {
        wrapperLayout->addWidget(bubbleWidget);
        // Ïò§Î•∏Ï™ΩÏóê Îπà Í≥µÍ∞Ñ(Spacer)ÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ ÎßêÌíçÏÑ†ÏùÑ ÏôºÏ™ΩÏúºÎ°ú Î∞ÄÏñ¥ÎÉÖÎãàÎã§.
        wrapperLayout->addSpacerItem(new QSpacerItem(1, 1, QSizePolicy::Expanding, QSizePolicy::Preferred));
        // ÏãúÍ∞Ñ ÎùºÎ≤®ÎèÑ ÏôºÏ™Ω Ï†ïÎ†¨
        timeLabel->setAlignment(Qt::AlignLeft);
    }
    else
    {
        // ÏôºÏ™ΩÏóê Îπà Í≥µÍ∞Ñ(Spacer)ÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ ÎßêÌíçÏÑ†ÏùÑ Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÏñ¥ÎÉÖÎãàÎã§.
        wrapperLayout->addSpacerItem(new QSpacerItem(1, 1, QSizePolicy::Expanding, QSizePolicy::Preferred));
        wrapperLayout->addWidget(bubbleWidget);
        // ÏãúÍ∞Ñ ÎùºÎ≤®ÎèÑ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨
        timeLabel->setAlignment(Qt::AlignRight);
    }

    // Ï†ÑÏ≤¥Î•º Í∞êÏã∏Îäî wrapperÎ•º ÏµúÏ¢Ö Î†àÏù¥ÏïÑÏõÉÏóê Ï∂îÍ∞Ä
    messageLayout->addLayout(wrapperLayout);

    // ÏûêÎèô Ïä§ÌÅ¨Î°§
    QTimer::singleShot(50, this, [=]()
                       { scrollArea->verticalScrollBar()->setValue(scrollArea->verticalScrollBar()->maximum()); });
}

void ChatBotWidget::processWithMcp(const QString &userInput)
{
    if (!mcpClient)
    {
        // MCPÍ∞Ä ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Gemini ÏßÅÏ†ë Ìò∏Ï∂ú
        if (gemini)
        {
            gemini->askGemini(this, userInput, [=](const QString &response)
                              {
                    ChatMessage botMsg = { "bot", response, getCurrentTime() };
                    addMessage(botMsg);
                    waitingForResponse = false;
                    sendButton->setEnabled(true); });
        }
        return;
    }

    // ÌÜµÌï© ÌååÏù¥ÌîÑÎùºÏù∏ Ïã§Ìñâ - Î™®Îì† Ï≤òÎ¶¨Î•º MCPÍ∞Ä Îã¥Îãπ
    mcpClient->executeUnifiedPipeline(userInput);
}

void ChatBotWidget::handleSend()
{
    QString text = input->text().trimmed();
    if (text.isEmpty())
        return;

    ChatMessage userMsg = {"user", text, getCurrentTime()};
    addMessage(userMsg);
    input->clear();

    waitingForResponse = true;
    sendButton->setEnabled(false);

    // MCP ÌÜµÌï© ÌååÏù¥ÌîÑÎùºÏù∏ÏúºÎ°ú Ï≤òÎ¶¨
    processWithMcp(text);
}

void ChatBotWidget::handleQuickReplyClicked()
{
    // ÌÄµÎ©îÎâ¥ ÎàÑÎ•¥Î©¥..
}

QString ChatBotWidget::getCurrentTime()
{
    return QTime::currentTime().toString("hh:mm AP");
}

void ChatBotWidget::initializeMqttClient()
{
    m_mqttClient = new QMqttClient(this);
    m_mqttClient->setHostname("mqtt.kwon.pics");
    m_mqttClient->setPort(1883);

    connect(m_mqttClient, &QMqttClient::connected, this, &ChatBotWidget::onMqttConnected);

    // MQTT ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞
    m_mqttClient->connectToHost();
}

// onMqttConnected Î©îÏÑúÎìú ÏàòÏ†ï - ÏùëÎãµ ÌÜ†ÌîΩ Íµ¨ÎèÖ Ï∂îÍ∞Ä
void ChatBotWidget::onMqttConnected()
{
    qDebug() << "ChatBot MQTT Connected";

    // Í∏∞Í∏∞ ÏÉÅÌÉú ÌÜ†ÌîΩ Íµ¨ÎèÖ
    QStringList statusTopics = {
        "feeder_02/status",
        "conveyor_03/status"};

    for (const QString &topic : statusTopics)
    {
        auto sub = m_mqttClient->subscribe(topic);
        if (sub)
        {
            connect(sub, &QMqttSubscription::messageReceived,
                    this, &ChatBotWidget::onMqttStatusReceived);
            qDebug() << "ChatBot subscribed to:" << topic;
        }
    }

    // Í∏∞Í∏∞ Î™ÖÎ†π ÌÜ†ÌîΩÎèÑ Íµ¨ÎèÖ (Í∏∞Í∏∞ ÏãúÎÆ¨Î†àÏù¥ÏÖòÏö©)
    QStringList commandTopics = {
        "feeder_02/cmd",
        "conveyor_03/cmd"};

    for (const QString &topic : commandTopics)
    {
        auto sub = m_mqttClient->subscribe(topic);
        if (sub)
        {
            connect(sub, &QMqttSubscription::messageReceived,
                    this, &ChatBotWidget::onMqttCommandReceived);
            qDebug() << "ChatBot subscribed to command topic:" << topic;
        }
    }

    // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏøºÎ¶¨ ÏùëÎãµ ÌÜ†ÌîΩ Íµ¨ÎèÖ
    auto queryResponseSub = m_mqttClient->subscribe(QString("factory/query/response"));
    if (queryResponseSub)
    {
        connect(queryResponseSub, &QMqttSubscription::messageReceived,
                this, &ChatBotWidget::onMqttMessageReceived);
    }

    // ÌÜµÍ≥Ñ ÏùëÎãµ ÌÜ†ÌîΩ Íµ¨ÎèÖ
    auto statsSub = m_mqttClient->subscribe(QString("factory/+/msg/statistics"));
    if (statsSub)
    {
        connect(statsSub, &QMqttSubscription::messageReceived,
                this, &ChatBotWidget::onMqttMessageReceived);
    }

    // Î∂àÎüâÎ•† Ï†ïÎ≥¥ ÌÜ†ÌîΩ Íµ¨ÎèÖ
    auto failureSub = m_mqttClient->subscribe(QString("factory/+/log/info"));
    if (failureSub)
    {
        connect(failureSub, &QMqttSubscription::messageReceived,
                this, &ChatBotWidget::onMqttMessageReceived);
    }
}

// MQTT ÏÉÅÌÉú Î©îÏãúÏßÄ ÏàòÏã† Ï≤òÎ¶¨
void ChatBotWidget::onMqttStatusReceived(const QMqttMessage &message)
{
    QString topic = message.topic().name();
    QString payload = QString::fromUtf8(message.payload());

    qDebug() << "ChatBot received status:" << topic << payload;

    // Í∏∞Í∏∞ ID Ï∂îÏ∂ú
    QString deviceId;
    if (topic == "feeder_02/status")
        deviceId = "feeder_02";
    else if (topic == "conveyor_03/status")
        deviceId = "conveyor_03";
    else
        return; // ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Í∏∞Í∏∞

    // ÎåÄÍ∏∞ Ï§ëÏù∏ Ï†úÏñ¥ Î™ÖÎ†πÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
    if (m_pendingControls.contains(deviceId))
    {
        QString expectedCommand = m_pendingControls[deviceId];

        if (payload == expectedCommand)
        {
            // ÌÉÄÏù¥Î®∏ Ï†ïÏßÄ
            if (m_controlTimers.contains(deviceId))
            {
                m_controlTimers[deviceId]->stop();
                m_controlTimers[deviceId]->deleteLater();
                m_controlTimers.remove(deviceId);
            }
            m_pendingControls.remove(deviceId);

            // ÏÑ±Í≥µ Î©îÏãúÏßÄ
            QString deviceKorean = getDeviceKoreanName(deviceId);
            QString actionText = (expectedCommand == "on") ? "ÏºúÏ°åÏäµÎãàÎã§" : "Í∫ºÏ°åÏäµÎãàÎã§";

            ChatMessage successMsg = {
                "bot",
                QString("‚úÖ %1Ïù¥ %2.").arg(deviceKorean, actionText),
                getCurrentTime()};
            addMessage(successMsg);
        }
    }
}

// ÌÉÄÏûÑÏïÑÏõÉ Ï≤òÎ¶¨
void ChatBotWidget::handleMqttControlTimeout(const QString &deviceId)
{
    if (m_pendingControls.contains(deviceId))
    {
        m_pendingControls.remove(deviceId);

        QString deviceKorean = getDeviceKoreanName(deviceId);
        ChatMessage errorMsg = {
            "bot",
            QString("‚ö†Ô∏è %1 Ï†úÏñ¥ ÏùëÎãµ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Í∏∞Í∏∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.").arg(deviceKorean),
            getCurrentTime()};
        addMessage(errorMsg);
    }

    // ÌÉÄÏù¥Î®∏ Ï†úÍ±∞
    if (m_controlTimers.contains(deviceId))
    {
        m_controlTimers[deviceId]->deleteLater();
        m_controlTimers.remove(deviceId);
    }
}

// Í∏∞Í∏∞ Ïù¥Î¶Ñ ÌïúÍ∏Ä Î≥ÄÌôò Ìó¨Ìçº
QString ChatBotWidget::getDeviceKoreanName(const QString &deviceId)
{
    if (deviceId == "feeder_02")
        return "ÌîºÎçî 2Î≤à";
    else if (deviceId == "conveyor_03")
        return "Ïª®Î≤†Ïù¥Ïñ¥ 3Î≤à";
    return deviceId;
}

// MQTT Î™ÖÎ†π ÏàòÏã† Ï≤òÎ¶¨ (Í∏∞Í∏∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò)
void ChatBotWidget::onMqttCommandReceived(const QMqttMessage &message)
{
    QString topic = message.topic().name();
    QString command = QString::fromUtf8(message.payload());

    qDebug() << "ChatBot received command:" << topic << command;

    // Í∏∞Í∏∞ ID Ï∂îÏ∂ú
    QString deviceId;
    if (topic == "feeder_02/cmd")
        deviceId = "feeder_02";
    else if (topic == "conveyor_03/cmd")
        deviceId = "conveyor_03";
    else
        return; // ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Í∏∞Í∏∞

    // Í∏∞Í∏∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    m_deviceStates[deviceId] = command;

    // ÏÉÅÌÉú ÌÜ†ÌîΩÏúºÎ°ú ÏùëÎãµ Î∞úÌñâ (Í∏∞Í∏∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò)
    QString statusTopic = QString("%1/status").arg(deviceId.split("/")[0]);
    QTimer::singleShot(500, this, [this, statusTopic, command]()
                       {
        if (m_mqttClient && m_mqttClient->state() == QMqttClient::Connected) {
            m_mqttClient->publish(QMqttTopicName(statusTopic), command.toUtf8());
            qDebug() << "Í∏∞Í∏∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏùëÎãµ:" << statusTopic << "->" << command;
        } });
}

void ChatBotWidget::onMqttMessageReceived(const QMqttMessage &message)
{
    QString topic = message.topic().name();
    QJsonDocument doc = QJsonDocument::fromJson(message.payload());
    QJsonObject response = doc.object();

    qDebug() << "ChatBot MQTT ÏàòÏã†:" << topic;

    // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏøºÎ¶¨ ÏùëÎãµ
    if (topic == "factory/query/response")
    {
        QString queryId = response["query_id"].toString();
        if (queryId == m_currentQueryId)
        {
            processMqttQueryResponse(response);
        }
    }
    // ÌÜµÍ≥Ñ ÏùëÎãµ
    else if (topic.contains("/msg/statistics"))
    {
        QString deviceId = response["device_id"].toString();
        double avgSpeed = response["average"].toDouble();
        double currentSpeed = response["current_speed"].toDouble();

        // MCPAgentClientÏóê Îç∞Ïù¥ÌÑ∞ Ï∫êÏã± (Ï∂úÎ†•ÌïòÏßÄ ÏïäÏùå)
        if (mcpClient)
        {
            mcpClient->cacheStatisticsData(deviceId, avgSpeed, currentSpeed);
        }

        qDebug() << "ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÎê®:" << deviceId << "ÌèâÍ∑†:" << avgSpeed << "ÌòÑÏû¨:" << currentSpeed;
    }
    // Î∂àÎüâÎ•† Ï†ïÎ≥¥
    else if (topic.contains("/log/info"))
    {
        QJsonObject msgData = response["message"].toObject();
        if (msgData.contains("failure"))
        {
            QString deviceId = topic.split('/')[1];
            double failureRate = msgData["failure"].toString().toDouble() * 100;
            int total = msgData["total"].toString().toInt();
            int pass = msgData["pass"].toString().toInt();
            int fail = msgData["fail"].toString().toInt();

            // MCPAgentClientÏóê Îç∞Ïù¥ÌÑ∞ Ï∫êÏã± (Ï∂úÎ†•ÌïòÏßÄ ÏïäÏùå)
            if (mcpClient)
            {
                mcpClient->cacheFailureStatsData(deviceId, failureRate, total, pass, fail);
            }

            qDebug() << "Î∂àÎüâÎ•† Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÎê®:" << deviceId << "Î∂àÎüâÎ•†:" << failureRate << "%";
        }
    }
}

// ÏøºÎ¶¨ ID ÏÉùÏÑ±
QString ChatBotWidget::generateQueryId()
{
    return QUuid::createUuid().toString(QUuid::WithoutBraces);
}

// MQTT ÏøºÎ¶¨ ÏùëÎãµ Ï≤òÎ¶¨
void ChatBotWidget::processMqttQueryResponse(const QJsonObject &response)
{
    QString status = response["status"].toString();
    if (status != "success")
    {
        ChatMessage errorMsg = {
            "bot",
            QString("‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®: %1").arg(response["error"].toString()),
            getCurrentTime()};
        addMessage(errorMsg);
        return;
    }

    QJsonArray dataArray = response["data"].toArray();

    // Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ Î∞è ÌëúÏãú
    QString resultMsg = "üìä **Ï°∞Ìöå Í≤∞Í≥º**\n\n";

    int count = 0;
    for (const QJsonValue &value : dataArray)
    {
        if (count >= 10)
        {
            resultMsg += QString("\n... Í∑∏Î¶¨Í≥† %1Í∞ú Îçî").arg(dataArray.size() - 10);
            break;
        }

        QJsonObject item = value.toObject();
        QString deviceId = item["device_id"].toString();
        QString logCode = item["log_code"].toString();
        qint64 timestamp = item["timestamp"].toVariant().toLongLong();

        QDateTime dateTime = QDateTime::fromMSecsSinceEpoch(timestamp);

        resultMsg += QString("‚Ä¢ %1 | %2 | %3\n")
                         .arg(dateTime.toString("MM-dd hh:mm"))
                         .arg(deviceId)
                         .arg(logCode);

        count++;
    }

    ChatMessage botMsg = {"bot", resultMsg, getCurrentTime()};
    addMessage(botMsg);
}

void ChatBotWidget::controlMqttDevice(const QString &deviceName, const QString &action)
{
    if (!m_mqttClient || m_mqttClient->state() != QMqttClient::Connected)
    {
        ChatMessage errorMsg = {
            "bot",
            "‚ö†Ô∏è MQTT ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
            getCurrentTime()};
        addMessage(errorMsg);
        return;
    }

    QString topic = getTopicForDevice(deviceName);
    if (topic.isEmpty())
    {
        // Ïª®Î≤†Ïù¥Ïñ¥2Ïù∏ÏßÄ ÌôïÏù∏
        QString device = deviceName.toLower();
        if (device.contains("Ïª®Î≤†Ïù¥Ïñ¥2") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥ 2") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥02"))
        {
            ChatMessage errorMsg = {
                "bot",
                "Ïª®Î≤†Ïù¥Ïñ¥2Îäî ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Í∏∞Îä•ÏûÖÎãàÎã§.",
                getCurrentTime()};
            addMessage(errorMsg);
        }
        else
        {
            ChatMessage errorMsg = {
                "bot",
                QString("‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî Ïû•ÎπÑÏûÖÎãàÎã§: %1").arg(deviceName),
                getCurrentTime()};
            addMessage(errorMsg);
        }
        return;
    }

    QString command = (action == "Ïºú" || action == "ÏãúÏûë" || action == "Í∞ÄÎèô" || action == "on") ? "on" : "off";

    m_mqttClient->publish(QMqttTopicName(topic), command.toUtf8());

    QString actionText = (command == "on") ? "ÏºúÏßê" : "Í∫ºÏßê";
    ChatMessage successMsg = {
        "bot",
        QString("‚úÖ %1Ïù¥(Í∞Ä) %2ÎêòÏóàÏäµÎãàÎã§.").arg(deviceName, actionText),
        getCurrentTime()};
    addMessage(successMsg);

    qDebug() << "MQTT Î™ÖÎ†π Ï†ÑÏÜ°:" << topic << "->" << command;
}

QString ChatBotWidget::getTopicForDevice(const QString &deviceName)
{
    // Ïû•ÎπÑÎ™ÖÏùÑ ÌÜ†ÌîΩÏúºÎ°ú Îß§Ìïë
    QString device = deviceName.toLower();

    if (device.contains("ÌîºÎçî2") || device.contains("ÌîºÎçî 2") || device.contains("ÌîºÎçî02") || device == "feeder_02")
    {
        return "feeder_02/cmd";
    }
    else if (device.contains("Ïª®Î≤†Ïù¥Ïñ¥2") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥ 2") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥02") || device == "conveyor_02")
    {
        return ""; // Ïª®Î≤†Ïù¥Ïñ¥2Îäî ÏßÄÏõêÌïòÏßÄ ÏïäÏùå
    }
    else if (device.contains("Ïª®Î≤†Ïù¥Ïñ¥3") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥ 3") || device.contains("Ïª®Î≤†Ïù¥Ïñ¥03") || device == "conveyor_03")
    {
        return "conveyor_03/cmd";
    }

    return ""; // Ïïå Ïàò ÏóÜÎäî Ïû•ÎπÑ
}

QString ChatBotWidget::getKoreanToolName(const QString &englishToolName)
{
    static QHash<QString, QString> toolNameMap = {
        {"db_find", "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï°∞Ìöå"},
        {"db_count", "Îç∞Ïù¥ÌÑ∞ Í∞úÏàò Ï°∞Ìöå"},
        {"db_aggregate", "Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ Î∂ÑÏÑù"},
        {"db_info", "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ïÎ≥¥"},
        {"device_control", "Ïû•ÎπÑ Ï†úÏñ¥"},
        {"mqtt_device_control", "MQTT Ïû•ÎπÑ Ï†úÏñ¥"},
        {"conveyor_failure_stats", "Ïª®Î≤†Ïù¥Ïñ¥ Ïû•Ïï† ÌÜµÍ≥Ñ"},
        {"device_statistics", "Ïû•ÎπÑ ÌÜµÍ≥Ñ"}};

    return toolNameMap.value(englishToolName, englishToolName);
}

// ÎìúÎûòÍ∑∏ Í∏∞Îä• Íµ¨ÌòÑ
void ChatBotWidget::mousePressEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton && m_headerWidget)
    {
        // Ìó§Îçî ÏòÅÏó≠ÏóêÏÑú ÌÅ¥Î¶≠ÌñàÎäîÏßÄ ÌôïÏù∏
        QPoint headerPos = m_headerWidget->mapToGlobal(QPoint(0, 0));
        QRect headerRect(headerPos, m_headerWidget->size());

        if (headerRect.contains(event->globalPos()))
        {
            m_dragging = true;
            m_dragStartPosition = event->globalPos() - frameGeometry().topLeft();
            event->accept();
            return;
        }
    }
    QWidget::mousePressEvent(event);
}

void ChatBotWidget::mouseMoveEvent(QMouseEvent *event)
{
    if (event->buttons() & Qt::LeftButton && m_dragging)
    {
        move(event->globalPos() - m_dragStartPosition);
        event->accept();
        return;
    }
    QWidget::mouseMoveEvent(event);
}

void ChatBotWidget::mouseReleaseEvent(QMouseEvent *event)
{
    if (event->button() == Qt::LeftButton)
    {
        m_dragging = false;
        event->accept();
        return;
    }
    QWidget::mouseReleaseEvent(event);
}

void ChatBotWidget::onToolDiscoveryCompleted(const ConversationContext &context)
{
    // ÎèÑÍµ¨ Î∞úÍ≤¨ ÏôÑÎ£å Ïãú Ï≤òÎ¶¨
    qDebug() << "Tool discovery completed for context";

    // ÌïÑÏöîÌïú Í≤ΩÏö∞ UI ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ Ï∂îÍ∞Ä
    // Ïòà: Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú, Î∞úÍ≤¨Îêú ÎèÑÍµ¨ Ï†ïÎ≥¥ ÌëúÏãú Îì±
}

void ChatBotWidget::onToolExecutionCompleted(const QString &result)
{
    // ÎèÑÍµ¨ Ïã§Ìñâ ÏôÑÎ£å Ïãú Ï≤òÎ¶¨
    qDebug() << "Tool execution completed with result:" << result;

    // Í≤∞Í≥ºÎ•º Ï±ÑÌåÖÏóê Ï∂îÍ∞Ä
    ChatMessage botMessage;
    botMessage.sender = "bot";
    botMessage.content = result;
    botMessage.time = getCurrentTime();
    addMessage(botMessage);

    waitingForResponse = false;
}

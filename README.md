# 🏭 Smart Factory Client Qt

## 📋 프로젝트 개요

Qt/C++ 기반의 스마트 팩토리 통합 모니터링 및 제어 시스템입니다. 실시간 영상 스트리밍, MQTT 기반 장비 제어, AI 챗봇, 데이터 분석 등 다양한 기능을 제공합니다.

### 🎯 주요 목적
- 공장 장비(피더, 컨베이어) 실시간 모니터링 및 제어
- 영상 기반 품질 관리 및 오류 감지
- AI 기반 자연어 명령 처리
- 통계 데이터 시각화 및 분석

## 🏗️ 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    통합 서버 (*.kwon.pics)                      │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│   MQTT Broker   │   MCP Server    │   Video Server  │ Auth/TOTP │
│   (IoT 통신)     │   (AI Backend)  │   (RTSP/HTTP)   │ (보안)     │
├─────────────────┼─────────────────┼─────────────────┼───────────┤
│                 │                 │                 │           │
│     MongoDB     │  Gemini API     │  영상 저장소     │  사용자DB  │
│   (데이터베이스)  │  (AI 처리)       │  (녹화 파일)     │  (인증)    │
└─────────────────┴─────────────────┴─────────────────┴───────────┘
                                    ▲
                                    │ MQTT/HTTP/RTSP
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Qt Client (GUI App)                       │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│   메인 대시보드   │   피더 제어      │   컨베이어 제어   │  AI 챗봇   │
│   (Home)        │  (MainWindow)   │  (Conveyor)     │  (MCP)    │
└─────────────────┴─────────────────┴─────────────────┴───────────┘
                                    ▲
                                    │ 제어 명령
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      공장 IoT 장비                              │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│     피더 1,2     │   컨베이어 1,2,3  │    로봇팔       │  카메라    │
│   (Feeder)      │   (Conveyor)    │  (Robot Arm)    │ (CCTV)    │
└─────────────────┴─────────────────┴─────────────────┴───────────┘
```

## 🛠️ 기술 스택

### Frontend
- **Qt 6** - GUI 프레임워크
- **C++17** - 프로그래밍 언어
- **OpenCV** - 영상 처리
- **Qt Charts** - 데이터 시각화
- **Qt Multimedia** - 미디어 재생

### Backend & Communication
- **MQTT** - IoT 장비 통신
- **HTTP REST API** - MCP 서버 통신
- **WebSocket** - 실시간 데이터 스트리밍
- **RTSP** - 영상 스트리밍

### AI & Data
- **Google Gemini API** - 자연어 처리
- **MCP (Model Context Protocol)** - AI 도구 통합
- **MongoDB** - 데이터베이스
- **JSON** - 데이터 교환 형식

## 📁 프로젝트 구조

```
client_qt/
├── 📂 ui/                     # 사용자 인터페이스
│   ├── mainwindow.*           # 피더 제어 창
│   ├── home.*                 # 메인 대시보드
│   ├── conveyor.*             # 컨베이어 제어 창
│   └── login_window.*         # 로그인 창
├── 📂 mcp/                    # AI 챗봇 시스템
│   ├── MCPAgentClient.*       # MCP 클라이언트
│   ├── chatbot_widget.*       # 챗봇 UI
│   ├── factory_mcp.*          # 팩토리 MCP 핸들러
│   ├── PromptGenerators.*     # AI 프롬프트 생성
│   └── DataFormatter.*        # 데이터 포맷팅
├── 📂 video/                  # 영상 처리
│   ├── streamer.*             # RTSP 스트리밍
│   ├── videoplayer.*          # 영상 재생기
│   └── video_mqtt.*           # MQTT 영상 제어
├── 📂 charts/                 # 데이터 시각화
│   ├── device_chart.*         # 장비 성능 차트
│   ├── device_speed_chart.*   # 속도 차트
│   └── errorchartmanager.*    # 오류 통계 차트
├── 📂 widgets/                # 커스텀 위젯
│   ├── error_message_card.*   # 오류 메시지 카드
│   ├── chartcardwidget.*      # 차트 카드
│   └── sectionboxwidget.*     # 섹션 박스
├── 📂 utils/                  # 유틸리티
│   ├── font_manager.*         # 폰트 관리
│   └── ai_command.*           # AI 명령 처리
├── 📂 config/                 # 설정 파일
│   └── gemini.key             # Gemini API 키
├── 📂 fonts/                  # 한화 폰트
└── 📂 images/                 # 아이콘 및 이미지
```

## 🚀 주요 기능

### 1. 🏠 메인 대시보드 (Home)
- **통합 모니터링**: 모든 장비 상태 실시간 확인
- **영상 스트리밍**: 3개 카메라 동시 모니터링
  - 피더 카메라 (RTSP: 192.168.0.76:8554)
  - 컨베이어 카메라 (RTSP: 192.168.0.36:8553)
  - 한화 카메라 (RTSP: 192.168.0.36:8553)
- **통합 제어**: 전체 공장 시작/정지
- **오류 로그 관리**: 실시간 오류 감지 및 기록
- **통계 차트**: 월별/일별 오류 통계 시각화

### 2. 🔧 피더 제어 시스템 (MainWindow)
- **실시간 제어**: 피더 시작/정지/잠금/리셋
- **MQTT 통신**: `feeder_01/status`, `feeder_02/cmd` 토픽
- **상태 모니터링**: 속도, 오류 상태 실시간 표시
- **로그 검색**: 날짜별, 오류코드별 검색
- **영상 연동**: 오류 발생 시 해당 시점 영상 자동 재생
- **통계 차트**: 속도 성능 그래프

### 3. 📦 컨베이어 제어 시스템 (ConveyorWindow)
- **다중 컨베이어 제어**: 컨베이어 1,2,3번 개별 제어
- **품질 관리**: 불량률 통계 및 파이 차트
- **MQTT 제어**: `conveyor_01/status`, `conveyor_03/cmd`
- **실시간 분석**: 투명/유색 페트병 분류 통계
- **오류 추적**: 컨베이어별 오류 로그 관리

### 4. 🤖 AI 챗봇 시스템 (MCP)
- **자연어 처리**: Google Gemini 2.5 Flash 모델 사용
- **스마트 제어**: "피더1 켜줘", "컨베이어 상태 확인해줘" 등
- **실시간 데이터 조회**: "오늘 에러 통계 보여줘"
- **통합 파이프라인**: 명령 분석 → 도구 선택 → 실행 → 결과 포맷팅
- **플로팅 챗봇 UI**: 드래그 가능한 채팅 창
- **빠른 응답 버튼**: 자주 사용하는 명령어 원클릭 실행
- **대화 컨텍스트 유지**: 이전 대화 기억 및 연속 질문 처리
- **실시간 상태 표시**: 파이프라인 진행 상황 시각화
- **지원 도구**:
  - `db_find`: MongoDB 로그 데이터 조회
  - `db_count`: 데이터 개수 확인
  - `db_aggregate`: 통계 집계 분석
  - `device_control`: HTTP 기반 장비 제어
  - `mqtt_device_control`: MQTT 기반 실시간 제어
  - `conveyor_failure_stats`: 불량률 통계 (캐시)
  - `device_statistics`: 장비 성능 통계 (캐시)
- **데이터 캐싱**: MQTT 통계 데이터 메모리 캐싱으로 빠른 응답
- **오류 복구**: 네트워크 오류 시 자동 재시도 메커니즘

### 5. 📊 데이터 시각화
- **실시간 차트**: Qt Charts 기반 동적 그래프
- **성능 모니터링**: 장비별 속도, 처리량 추적
- **품질 분석**: 불량률, 양품률 파이 차트
- **트렌드 분석**: 시간대별 성능 변화 추적

### 6. 📹 영상 관리 시스템
- **멀티 스트림**: OpenCV 기반 RTSP 스트리밍
  - 피더 카메라: `rtsp://192.168.0.76:8554/process1`
  - 컨베이어 카메라: `rtsp://192.168.0.36:8553/stream_pno`
  - 한화 카메라: `rtsp://192.168.0.36:8553/stream_pno`
- **오류 연동 영상 재생**:
  - 오류 발생 시점 ±5분 영상 자동 검색
  - HTTP API를 통한 영상 파일 다운로드
  - Qt Multimedia 기반 영상 플레이어 팝업
  - 영상 재생 중 카메라 자동 줌인/아웃
- **실시간 카메라 제어**:
  - MQTT 기반 PTZ(Pan/Tilt/Zoom) 제어
  - `factory/hanwha/cctv/zoom`: 줌 레벨 조정 (-100~100)
  - `factory/hanwha/cctv/cmd`: 포커스, 프리셋 등 명령
- **영상 저장 및 관리**:
  - 서버 측 자동 녹화 (24시간 보관)
  - 오류 시점 영상 자동 백업
  - HTTP 기반 영상 스트리밍 및 다운로드

### 7. 🔐 보안 및 인증 시스템
- **다단계 인증**: 사용자명/비밀번호 + TOTP 2FA
- **TOTP (Time-based OTP)**: Google Authenticator 호환 6자리 코드
- **QR 코드 등록**: 초기 TOTP 설정을 위한 QR 스캔
- **세션 관리**: JWT 토큰 기반 인증 상태 유지
- **권한 관리**: 역할 기반 장비별 접근 권한 제어
- **자동 로그아웃**: 비활성 시간 초과 시 보안 로그아웃
- **로그인 이력**: 접근 시간 및 IP 추적

## 🎮 사용법

### 기본 조작
1. **로그인 프로세스**:
   - 사용자명/비밀번호 입력
   - TOTP 6자리 코드 입력 (Google Authenticator)
   - 인증 성공 시 메인 대시보드 접근
2. **장비 선택**: 피더/컨베이어 탭으로 이동
3. **실시간 모니터링**: 영상 및 상태 정보 확인
4. **제어 명령**: 버튼 클릭 또는 AI 챗봇으로 제어

### TOTP 설정 방법
1. **초기 설정**:
   - 로그인 창에서 "TOTP 설정" 버튼 클릭
   - QR 코드가 표시된 다이얼로그 창 열림
   - Google Authenticator 앱으로 QR 코드 스캔
   - 생성된 6자리 코드 입력하여 설정 완료
2. **일반 로그인**:
   - 사용자명/비밀번호 입력 후
   - Google Authenticator에서 생성된 6자리 코드 입력
   - 30초마다 갱신되는 코드 사용

### AI 챗봇 명령어 예시
```
✅ 장비 제어
- "피더1 켜줘"
- "컨베이어2 정지해줘"
- "로봇팔 가동시켜"

✅ 상태 조회
- "컨베이어1 오늘 정보 보여줘"
- "피더2 어제 로그 확인해줘"
- "불량률 통계 알려줘"

✅ 데이터 분석
- "이번달 에러 통계 보여줘"
- "6월 생산량 데이터"
- "장비 성능 분석해줘"
```

### 검색 및 필터링
- **날짜 범위**: 시작일~종료일 설정
- **오류 코드**: SPD, INF, ERR 등으로 필터링
- **장비별**: 특정 장비 로그만 조회
- **실시간/과거**: 실시간 모드와 과거 데이터 모드 전환

## 🔧 설치 및 설정

### 시스템 요구사항
- **OS**: Windows 10/11
- **Qt**: 6.0 이상
- **OpenCV**: 4.x
- **컴파일러**: MinGW 또는 MSVC
- **메모리**: 4GB 이상 권장

### 빌드 방법
```bash
# 1. 저장소 클론
git clone [repository-url]
cd client_qt

# 2. CMake 빌드
mkdir build
cd build
cmake ..
make

# 3. 실행
./client_qt
```

### 설정 파일
```
config/
└── gemini.key          # Gemini API 키 설정
```

### 네트워크 설정
```cpp
// MQTT 브로커 설정
QString mqttBroker = "mqtt.kwon.pics";
int mqttPort = 1883;

// 영상 스트림 URL
"rtsp://192.168.0.76:8554/process1"    // 피더 카메라
"rtsp://192.168.0.36:8553/stream_pno"  // 한화 카메라
```

## 📡 MQTT 토픽 구조

### 장비 제어
```
feeder_01/status        # 피더1 상태 수신
feeder_02/cmd           # 피더2 명령 송신
conveyor_01/status      # 컨베이어1 상태
conveyor_03/cmd         # 컨베이어3 명령
robot_arm_01/cmd        # 로봇팔 명령
```

### 데이터 수집
```
factory/+/msg/statistics     # 장비 통계 데이터
factory/+/log/error         # 오류 로그
factory/+/log/info          # 정보 로그
factory/msg/status          # 전체 상태
```

### 영상 제어
```
factory/hanwha/cctv/zoom    # 카메라 줌 제어
factory/hanwha/cctv/cmd     # 카메라 명령
```

## 🎨 UI/UX 특징

### 디자인 시스템
- **컬러 팔레트**: 한화 오렌지 (#fb923c) 기반
- **타이포그래피**: 한화고딕 폰트 패밀리
- **레이아웃**: 반응형 그리드 시스템
- **애니메이션**: 부드러운 전환 효과

### 사용자 경험
- **직관적 네비게이션**: 탭 기반 화면 전환
- **실시간 피드백**: 즉시 상태 반영
- **시각적 알림**: 색상 기반 상태 표시
- **접근성**: 키보드 단축키 지원

## 🔍 데이터 흐름

### 실시간 모니터링
```
IoT 장비 → MQTT → Qt Client → UI 업데이트
```

### AI 명령 처리
```
사용자 입력 → Gemini API → MCP 도구 선택 → 실행 → 결과 표시
```

### 영상 처리
```
RTSP 스트림 → OpenCV → Qt 이미지 → UI 표시
```

### 데이터 저장
```
센서 데이터 → MQTT → MCP Server → MongoDB
```

## 🚨 오류 처리 및 복구

### 자동 복구 기능
- **MQTT 재연결**: 연결 끊김 시 자동 재시도
- **영상 스트림 복구**: 스트림 오류 시 재연결
- **API 재시도**: 네트워크 오류 시 재요청
- **데이터 캐싱**: 오프라인 시 캐시된 데이터 사용

### 오류 알림
- **시각적 표시**: 빨간색 상태 표시
- **로그 기록**: 모든 오류 자동 기록
- **알림 메시지**: 팝업 및 토스트 메시지
- **영상 연동**: 오류 시점 영상 자동 재생

## 📈 성능 최적화

### 메모리 관리
- **스마트 포인터**: 자동 메모리 해제
- **객체 풀링**: 재사용 가능한 객체 관리
- **캐시 전략**: 자주 사용되는 데이터 캐싱

### 네트워크 최적화
- **비동기 통신**: 논블로킹 네트워크 요청
- **연결 풀링**: MQTT 연결 재사용
- **압축**: JSON 데이터 압축 전송

### UI 성능
- **가상화**: 대용량 리스트 가상화
- **지연 로딩**: 필요시에만 UI 생성
- **애니메이션 최적화**: GPU 가속 사용

**🏭 Smart Factory Client Qt** - 미래의 스마트 팩토리를 위한 통합 솔루션
